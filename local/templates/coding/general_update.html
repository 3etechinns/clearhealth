<script type='text/javascript' src='{$base_dir}jpspan_server.php?client'></script>
<SCRIPT type='text/javascript' src="{$base_dir}js/autocomplete2.js"></script>
{literal}
<script language="javascript">
function captureEnter (field, event) {
		var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
		if (keyCode == 13) {
			var i;
			for (i = 0; i < field.form.elements.length; i++)
				if (field == field.form.elements[i])
					break;
			i = (i + 1) % field.form.elements.length;
			field.form.elements[i].focus();
			return false;
		} 
		else
		return true;
	}      

</script>
{/literal}

{clni_form name="coding_form" action=$FORM_ACTION autocomplete="off" process=$PROCESS}
<input type="hidden" name="foreign_id" value="{$foreign_id}">
{if $encounter->get('status') != 'closed'}
<fieldset id="coding_data">
<legend>Edit Claim Line</legend>
<div id="acDiv" style="border: 1px solid black; background-color: white; z-index: 20; visibility: hidden;"><div class="AutoCompleteBackground"></div></div>
<table>
	<tr>
		<td valign="top">
			<table>
				<tr>
					<td valign="top">
						<label>CPT Code: </label>
					</td>
					<td valign="top">
						<input TYPE="hidden" name="parent_id"  id="parent_id" value="{$parent_id}">
						<input TYPE="text" onkeypress="return captureEnter(this, event)" CLASS="input_text" autofield="parent_id"
							name="parent_code" id="parent_code" SIZE="35" autocomplete="off" value="{$parent_code->getCodeDesc()}">
						<select name="modifier" STYLE="z-index: 1;" id="modifier">
							{html_options options=$code_data->getModifierList() selected=$code_data->get('modifier')}
						</select>
						<input type="button" name="add_cpt" value="Add CPT" onClick="addCPTCode()">
						<div id="cptlist">
						</div>
					</td>
				</tr>
				<tr>
					<td valign="top">
						<label style="display:inline;">Units: </label></b>
					</td>
					<td>
						<input TYPE="text" CLASS="input_text" name="units" id="units" SIZE="7" value="{$code_data->get('units')}">
						&nbsp;<label style="display:inline;">SuperBill</label> <input type="checkbox" name="superbill" value="1" {if $superbill}checked{/if}>
					</td>
				</tr>
			</table>
		</td>
		<td valign="top">
			<table>
				<tr>
					<td valign="top">
						<label>ICD Code:</label>
					</td>
					<td valign="top">
						<input TYPE="hidden" name="child_codes[]"  id="child_id" value="">
						<input TYPE="text" onkeypress="return captureEnter(this, event)" CLASS="input_text" 
						name="child_code" id="child_code" SIZE="35" autocomplete="off" value="">
						<input type="button" name="add_code" value="Add ICD" onClick="addICDCode()">
						
						<div id="child_codes">
			  			{foreach name="icd_list" from=$child_codes item=code}
			  			<input TYPE="hidden" name="child_codes[{$code.code_id}]" value="{$code.code_id}">
			  			{if $smart.foreach.icd_list.first}
						<strong>{$code.description}</strong><BR>
						{else}
						{$code.description}<BR>
						{/if}
						
						{/foreach}
						</div>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td colspan="2" align="right">
			<input type="submit" name="saveCode" value="Add Claim Line">
  		</td>
	</tr>
</table>
</fieldset>
{/if}
<fieldset class="radio" id="Code List">
<legend>Claim Lines</legend>
{foreach from=$code_list item=code}
{assign var=children value=$code_data->getChildCodes($code.foreign_id, $code.parent_id)}
<A HREF="{$EDIT_LINK}parent_id={$code.parent_id}">{$code.description}</A><BR>
{foreach from=$children item=child}
&nbsp;&nbsp;&nbsp;{$child.description}<br>
{/foreach}<BR>
{/foreach}
&nbsp;
</fieldset>
</form>




{literal}
<script language="javascript">
function setupAutoComplete(){
	var ac = new AutoComplete(
		CPTSearch,
	    'parent_code',
	    'parent_id',
	    'acDiv',
	    true,
	    600
	);

	var ac = new AutoComplete(
		ICDSearch,
	    'child_code',
	    'child_id',
	    'acDiv',
	    true,
	    600
	);
}

var CPTSearch = function cpt_search(searchString) {
        var h = new c_coding(this.dataHandler);
        h.Sync();
                                                                                
		if(searchString.length > 0){
        	var results = h.cpt_search(searchString,document.forms.coding_form.superbill.checked);
        	return results;
		}
		
		return;
}

var ICDSearch = function icd_search(searchString) {
        var h = new c_coding(this.dataHandler);
        h.Sync();
                                                                                
		if(searchString.length > 0){
        	var results = h.icd_search(searchString,document.forms.coding_form.superbill.checked);
        	return results;
		}
		
		return;
}

function addICDCode(){
	//TODO: Move the current code to the bottom of the list
	var childDiv = document.getElementById('child_codes');
	var icdCode = document.getElementById('child_id');
	var icdCodeText = document.getElementById('child_code');

	if (icdCode.value == "" ) {
		clni_notify_alert(icdCodeText);
		return false;
	}
	else {
		clni_notify_alert_reset(icdCodeText);
	}
//	alert('Adding ICD Code ' + icdCode.value)
	if (childDiv.childNodes.length == 1) {
		childDiv.innerHTML = childDiv.innerHTML + '<input TYPE="hidden" name="child_codes[' + icdCode.value  + ']" value="' + icdCode.value  + '"><strong>' + icdCodeText.value  + '</strong><BR>';
	}
	else {
		childDiv.innerHTML = childDiv.innerHTML + '<input TYPE="hidden" name="child_codes[' + icdCode.value  + ']" value="' + icdCode.value  + '">' + icdCodeText.value  + '<BR>';
	}
	icdCode.value = '';
	icdCodeText.value = '';
	icdCodeText.focus();
}
setupAutoComplete();

function clni_rule_hasicd(element) {
	var childDiv = document.getElementById('child_codes');
	if (childDiv.childNodes.length == 1) {
		return false;
	}
	return true;
}
function clni_rule_hascpt(element) {
	if (document.getElementById('parent_id').value > 0) {
		return true;
	}
	var childDiv = document.getElementById('cptlist');
	if (childDiv.childNodes.length == 1) {
		return false;
	}
	return true;

}

function addCPTCode() {
	var listDiv = document.getElementById('cptlist');
	var cptCode = document.getElementById('parent_id');
	var cptText = document.getElementById('parent_code');
	var units = document.getElementById('units');
	var modfier = document.getElementById('modifier');

	if (cptCode.value == "") {
		clni_notify_alert(cptText);
		return false;
	}
	else {
		clni_notify_alert_reset(cptText);
	}

	var modStr = "";
	if (modifier.value > 0) {
		modStr = ' ('+modifier.options[modifier.selectedIndex].text+')';
	}

	listDiv.innerHTML = listDiv.innerHTML  
		+ '<input TYPE="hidden" name="parent_codes[' + cptCode.value  + '][code]" value="' + cptCode.value  + '">' 
		+ '<input TYPE="hidden" name="parent_codes[' + cptCode.value  + '][modifier]" value="' + modifier.value  + '">' 
		+ '<input TYPE="hidden" name="parent_codes[' + cptCode.value  + '][units]" value="' + units.value  + '">' 
		+ cptText.value + modStr + ' - Units: '+ units.value +'<BR>';
	cptCode.value = '';
	cptText.value = '';
	units.value = '1.00';
	modifier.selectedIndex = 0;
	cptText.focus();
}
</script>
{/literal}
{clni_register_validation_rule id="parent_code" rule="hascpt"}
{clni_register_validation_rule id="child_code" rule="hasicd"}
