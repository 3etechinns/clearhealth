<script type="text/javascript" src="{$base_dir}js/zipcode.js"></script>
	<fieldset id="address">
		<legend>{l}Addresses{/l} {clni_section_links name="address"}</legend>
<table class="grid" border="0" cellspacing="1" cellpadding="0">
        {$pager}
	<tr>
		<th>{l}Name{/l}</th><th>{l}Type{/l}</th><th>{l}Address{/l}</th><th>{l}City{/l}</th><th>{l}Zip{/l}</th>
        </tr>
        {foreach from=$parent->get_addresses() item=row name="address"}
	<tr {if $row.address_id == $address->get('address_id')}class="selectedRow"{else}{if $smarty.foreach.address.iteration %2 == 1}class="alt"{/if}{/if}>
		<td><a href="{$EDIT_ADDRESS_ACTION}id={$row.address_id}&process=true">{$row.name}</a></td>
		<td>{$row.type}</td>
		<td class="address">
			<a href="{$EDIT_ADDRESS_ACTION}id={$row.address_id}&process=true">
				{$row.line1}<br>{$row.line2}</a>
		</td>
		<td>{$row.city}</td>
		<td>{$row.postal_code}</td>
		<td><a onClick="return confirm('Delete Address {$row.name}?:\n{$row.line1}\n{$row.line2}\n{$row.city} {$row.state}, {$row.postal_code}')" href="{$DELETE_ADDRESS_ACTION}id={$row.address_id}&process=true">delete</a></td>
        </tr>
        {foreachelse}
        <tr>
		<td colspan="5">{l}No Addresses{/l}
			{assign var="addressRequired" value=1}
		</td>
        </tr>
        {/foreach}
</table>
		{if $address->get('address_id') > 0}
		<input type="hidden" name="address[address_id]" value="{$address->get('address_id')}">
		{/if}
                    <table>
                        <tr>
				<td><label>{l}Name{/l}:</label> </td>
				<td><input id="addrName" name="address[name]" size="20" value="{$address->get('name')}"></td>
			  <td><label>{l}Type{/l}:</label> </td>
			  <td>
				<select name="address[type]" class="requiredIfAny" onclick="updateAddrName(this)">
					<option></option>
					{html_options options=$address->getTypeList() selected=$address->get('type')}
				</select>
			  </td>
                        </tr>

                        <tr>
				<td><label>{l}Address{/l}:</label> </td>
			  <td colspan="3">
				  <input name="address[line1]" size="30" value="{$address->get('line1')}"><br>
				  <input name="address[line2]" size="30" value="{$address->get('line2')}">
			  </td>
                        </tr>
                        <tr>
				<td><label>{l}City{/l}:</label> </td>
				<td><input name="address[city]" id="addresscity" size="15" value="{$address->get('city')}"></td>
				{*<td><label>{l}State{/l}:</label> </td>*}
				<td>
					<select name="address[state]" id="addressstate">
						<option value=0>State</option>
					{html_options options=$address->getStateList() selected=$address->get('state')}
					</select>
				</td>	
				<td><label class="inline">{l}Zip{/l}:</label> 
				<input name="address[postal_code]" size="10" id="addresspostalcode" value="{$address->get('postal_code')}" onkeyup="if(this.value.length==5) zipGrab(this.value);"></td>
      </tr>
                        <tr>
				<td><label>{l}Notes{/l}:</label> </td>
				<td colspan=3"><textarea name="address[notes]" rows="2" cols="35">{$address->get('notes')}</textarea><br />
				<input id="returned_mail" type="hidden" name="address[returned_mail]" value='0'>
				<input id="returned_mail" type="checkbox" name="address[returned_mail]" value='1' {if $address->get('returned_mail') > 0}CHECKED{/if} /> {l}Returned to Sender/Bad Address{/l}
				</td>
                        </tr>
                        <tr>
				<td></td><td colspan="3"><input type="submit" {if $address->get('address_id') > 0}value="Update"><input type="submit" value="Add as New" name="address[add_as_new]">{else}value="Add">{/if}</td>
                        </tr>
		</table>
	</fieldset>
{if $addressRequired}
{*clni_register_validation_rule id="addrName" message="Every Patient requires an Address, if this patient doesn't have an address add one with a name of \"No Address\" to signify this."*}
{/if}
{literal}
<script type="text/javascript">
	var addressElements = [];
	Behavior.register('#address',function(element) 
		{
			var inputs = element.getElementsByTagName('input');
			for(var i = 0; i < inputs.length; i++) {
				if (inputs[i].type != 'submit' && inputs[i].type != 'hidden') {
					clni_register_validation_rule_hash({obj:inputs[i],rule:'addressRequiredIf'});
					addressElements.push(inputs[i]);
				}
			}
			var selects = element.getElementsByTagName('select');
			for(var i = 0; i < selects.length; i++) {
				clni_register_validation_rule_hash({obj:selects[i],rule:'addressRequiredIf'});
				addressElements.push(selects[i]);
			}
		}
	);

	function  clni_rule_addressRequiredIf(element) {
		var required = false;
		// if any of the elements are filled out all are required
		for(var i =0; i < addressElements.length; i++) {
			if (!(addressElements[i].value == 0 || addressElements[i].value == '' || addressElements[i].checked == false)) {
				required = true;
			}
		}
		if (addressElements[0].value == 'No Address') {
			required = false;
		}
		if (element.name.match(/line2\]$/)) {
			return true;
		}
		if (required) {
			if (element.tagName == 'SELECT' && (element.value == 0 || element.value == '')) {
				return false;
			} else if (element.value == '') {
				return false;
			}
		}
		return true;
	}

	function updateAddrName(select) {
		var name = document.getElementById('addrName');
		if (name.value == '') {
			name.value = select.options[select.selectedIndex].text;
		}
	}
</script>
{/literal}
